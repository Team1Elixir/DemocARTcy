const io = require('socket.io-client');
const http = require('http');
const ioBack = require('socket.io');
// jest.setTimeout(30000);

let socket;
let httpServer;
let httpServerAddr;
let ioServer;

beforeAll((done) => {
    httpServer = http.createServer().listen();
    httpServerAddr = httpServer.address();
    ioServer = ioBack(httpServer);
    done();
});

afterAll((done) => {
    ioServer.close();
    httpServer.close();
    done();
});

beforeEach((done) => {
    socket = io.connect(`http://localhost:4000`, {
      'reconnection delay': 0,
      'reopen delay': 0,
      'force new connection': true,
      transports: ['websocket'],
    });
    socket.on('connect', () => {
      done();
    });
});

afterEach((done) => {
    if (socket.connected) {
      socket.disconnect();
    }
    done();
});


describe('Live Sketch Test', () => {
    describe('Mouse Event', () => {
        test('should return mouse coordinate', () => {
            const data = {
                x: 1,
                y: 2,
                px: 3,
                py: 4
            }
            socket.emit('mouse', data);

            // setTimeout(() => {
            ioServer.on('mouse', data => {
                console.log(data);  
                expect(data).toHaveProperty('x');
                expect(data).toHaveProperty('y');
                expect(data).toHaveProperty('px');
                expect(data).toHaveProperty('py');
            })
            // }, 50);
        });
    });
});